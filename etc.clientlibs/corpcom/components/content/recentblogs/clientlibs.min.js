/**
* Recent Blogs Component JS
*
**/

$("#errorMsgRecentBlogs").hide();

var blogsElem = document.querySelector('#recentBlogs');
blogsElem = (blogsElem == null) ? document.querySelector('#recentBlogsVar2') : blogsElem

//Fetch function to get the recent blogs
fetch('/corpcomsvc/getRecentBlogsFromWarpper?'+ new URLSearchParams({
    blogsCount: blogsElem.dataset.blogscount
}))
    .then(response => response.json())
    .then(data => populateRecentBlogs(data));

//Populate List of recent blogs from wrapper response
function populateRecentBlogs(data) {

    if(!data || data.TotalNumberOfResults===0 || data.status===2){
		var _errElem = document.querySelector('#errorMsgRecentBlogs');
        _errElem.innerHTML = blogsElem.dataset.noblogsfound;
	$("#errorMsgRecentBlogs").show();
        return;
    }

    var showAuthor = ($('#showAuthor') != null) ? $('#showAuthor').val() : 0;
    var showDescription= ($('#showDescription') != null) ? $('#showDescription').val() : 0;
    var showReadMore= ($('#showReadMore') != null) ? $('#showReadMore').val() : 0;
    var showImage= ($('#showImage') != null) ? $('#showImage').val() : 0;

    //console.log("showAuthor:"+showAuthor);
   //  console.log("showDescription:"+showDescription);
    // console.log("showReadMore:"+showReadMore);
    //console.log("showImage:"+showImage);

    if(showAuthor || showDescription || showReadMore || showImage){

			 var blogs = document.getElementById('recentBlogsVar2');
             if (blogs) {
					var str = "";
                 for (var i = 0; i < data.SearchResult.length; i++) {

                     str = str+ '<div class="row listing">';

                     if(showImage ){

						str = str + '<div class="col-md-4">';

                         if( data.SearchResult[i].thumbnailImg != null){
								str = str + '<img src="'+data.SearchResult[i].thumbnailImg+'" alt="">';
                         }

                        str = str + '</div>';
                     }

                     str = str+ '<div class="col-md-8">' +
                         '<h3><a href="'+  data.SearchResult[i].url +'">'+data.SearchResult[i].title+'</a></h3>';

                     str = str + '<p class="dateline">';

                      if(showAuthor && data.SearchResult[i].authorJson != null ){

						str = str +parseAuthorJson(data.SearchResult[i].authorJson)+ ' Â· ';
                     }

						str = str +getFormattedBlogDate(data.SearchResult[i].releaseDate,'long') + '</p>';

                      if(showDescription && data.SearchResult[i].digest != null ){

						str = str + '<p>'+data.SearchResult[i].digest+'</p>';
                     }

                      if(showReadMore && showReadMore != "" ){

						str = str + '<p><span class="read-more"><a href="'+data.SearchResult[i].url+'" class="link-arrow" >'+showReadMore+'</a></span></p>';
                     }


						 str = str + '</div>';
                         str = str + '</div>';
                 }


                     $('#recentBlogsVar2').html(str);
             }

    }else{

        var blogs = document.getElementById('recentBlogs');
        if (blogs) {
            var ul = document.createElement('ul');
            ul.className = 'listnostyle';
            for (var i = 0; i < data.SearchResult.length; i++) {
                var li = document.createElement('li');
                var anchor = document.createElement('a');
                var anchorTitle = document.createElement('p');
                var dateParagraph = document.createElement('p');
                anchorTitle.className = "overline recentTitle";
                dateParagraph.className = 'blogDate';
                ul.appendChild(li);
                li.appendChild(dateParagraph);
                anchor.appendChild(anchorTitle);
                li.appendChild(anchor);
                dateParagraph.innerHTML = getFormattedBlogDate(data.SearchResult[i].releaseDate);
                anchorTitle.innerHTML = data.SearchResult[i].title;
                anchor.href = data.SearchResult[i].url;

            }
            blogs.appendChild(ul);
        }
    }
}

function getFormattedBlogDate(dateStr, month){
    if(dateStr == null || dateStr == ""){
		return "";
    }

    var monthType = (month != null && month ==="long") ? 'long' :'short';

    var dateOptions = { month: monthType, day: 'numeric',  year: 'numeric',timeZone: 'UTC'};


    var blogDate = new Date(dateStr);

    return blogDate.toLocaleString('default', dateOptions);

}

function parseAuthorJson(authorJson){

    if(authorJson == null || authorJson ===""){
			return "";

    }

    var str="";
    var obj = JSON.parse(authorJson);

    for (var key in obj){
		if (obj.hasOwnProperty(key)) {
            var val = obj[key];
            console.log(val);
                if(val !=null && val !=""){
                    if(str !=""){
 						str = str+' and ';
                    }
                    str = str+'<a href="'+val+'">'+key+'</a>';
                }else{
 					str = str+  key;
                }
          }

    }

    if(str !=""){
			str = 'By '+str;
    }

    return str;

}

